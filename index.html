<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Growise - Personal Wellbeing</title>
    
    <!-- PWA Setup Links -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10B981">

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#10B981', // Emerald Green
                        'secondary': '#3B82F6', // Blue
                        'background': '#F9FAFB',
                        'card': '#FFFFFF',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        .chat-container::-webkit-scrollbar { display: none; }
        .chat-container { -ms-overflow-style: none; scrollbar-width: none; }
        /* FIX: Ensure input and button are visually aligned and clickable */
        #chat-input-container {
            display: flex;
            align-items: stretch;
        }
        #chat-input {
            border-right: none;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            z-index: 10;
        }
        #chat-send-btn {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            z-index: 10; /* Ensures the button is always on top */
        }
    </style>
</head>
<body class="bg-background min-h-screen antialiased">

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, GithubAuthProvider, OAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // Global Firebase functions accessible in <script> below
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.collection = collection;
        window.setLogLevel = setLogLevel;
        
        // Expose Auth Providers and Popup Sign-in
        window.GoogleAuthProvider = GoogleAuthProvider;
        window.GithubAuthProvider = GithubAuthProvider;
        window.OAuthProvider = OAuthProvider;
        window.signInWithPopup = signInWithPopup;
        window.getAnalytics = getAnalytics;
    </script>

    <div id="app" class="max-w-4xl mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="flex justify-between items-center py-4 border-b border-gray-200 mb-6">
            <h1 class="text-3xl font-extrabold text-primary">
                <span class="text-secondary">Grow</span>ise
            </h1>
            <div id="user-info" class="text-sm text-gray-600 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-1 text-secondary">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                </svg>
                User ID: <span id="user-id" class="ml-1 font-mono text-xs">Loading...</span>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="flex space-x-2 p-1 bg-white rounded-xl shadow-lg mb-8">
            <button data-tab="dashboard" class="tab-button w-full py-3 px-4 text-center rounded-lg font-semibold bg-primary text-white transition-all">Dashboard</button>
            <button data-tab="focus" class="tab-button w-full py-3 px-4 text-center rounded-lg font-semibold text-gray-500 hover:bg-gray-100 transition-all">Focus & Reward</button>
            <button data-tab="chat" class="tab-button w-full py-3 px-4 text-center rounded-lg font-semibold text-gray-500 hover:bg-gray-100 transition-all">WiseMind Chat</button>
        </nav>

        <!-- Main Content Area (Tab Views) -->
        <main>
            <!-- Login Prompt (Initially Visible) -->
            <div id="login-prompt" class="bg-card p-8 rounded-xl shadow-xl border-t-4 border-secondary text-center space-y-6">
                <h2 class="text-2xl font-bold text-gray-800">Welcome to Growise!</h2>
                <p class="text-gray-600">Please sign in to access your personal dashboard, track rewards, and talk to WiseMind.</p>
                <div class="space-y-3 max-w-sm mx-auto">
                    <button id="google-login-btn" class="w-full py-3 px-4 flex items-center justify-center bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition-all">
                        <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor"><path d="M12.24 10.27c.2.58.3.94 0 1.55-.38.86-.87 1.83-.87 3.42 0 1.5.76 2.5 2.18 2.5 1.13 0 1.76-.58 1.95-1.15h1.9c-.27 1.6-1.5 2.87-3.8 2.87-2.6 0-4.63-1.87-4.63-4.67 0-2.83 2-4.8 4.77-4.8 2.47 0 3.73 1.25 3.73 3.63 0 .43-.07.8-.13 1.15H12.24zm-6.1-4.75c.67-1.13 2.05-1.9 3.55-1.9 1.5 0 2.88.77 3.55 1.9l.06.1-.06-.1c-.67-1.13-2.05-1.9-3.55-1.9-1.5 0-2.88.77-3.55 1.9l-.06.1.06-.1zM12 2c5.52 0 10 4.48 10 10s-4.48 10-10 10S2 17.52 2 12 6.48 2 12 2zm0 18c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8z" fill="#FFFFFF"></path></svg>
                        Sign in with Google
                    </button>
                    <button id="github-login-btn" class="w-full py-3 px-4 flex items-center justify-center bg-gray-800 text-white font-semibold rounded-lg shadow-md hover:bg-gray-900 transition-all">
                        <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.6.11.817-.26.817-.57v-2.098c-3.332.723-4.04-1.609-4.04-1.609-.545-1.385-1.328-1.754-1.328-1.754-1.089-.745.083-.73.083-.73 1.205.085 1.838 1.238 1.838 1.238 1.07 1.833 2.809 1.303 3.492.997.108-.775.419-1.303.762-1.603-2.665-.302-5.466-1.334-5.466-5.93 0-1.312.468-2.383 1.236-3.224-.124-.302-.534-1.523.118-3.176 0 0 1.007-.323 3.3 1.23.957-.266 1.983-.4 3-.404.975.004 2.002.138 3 .404 2.29-1.553 3.297-1.23 3.297-1.23.652 1.653.242 2.874.118 3.176.77.841 1.235 1.912 1.235 3.224 0 4.609-2.807 5.624-5.473 5.92.43.37.813 1.102.813 2.224v3.293c0 .31.218.68.823.57 4.766-1.586 8.204-6.085 8.204-11.387C24 5.373 18.627 0 12 0z" fill="#FFFFFF"></path></svg>
                        Sign in with GitHub
                    </button>
                    <button id="apple-login-btn" class="w-full py-3 px-4 flex items-center justify-center bg-gray-900 text-white font-semibold rounded-lg shadow-md hover:bg-black transition-all">
                        <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor"><path d="M12.004 0C13.567 0 15.004 1.22 15.004 2.766c0 1.547-1.096 2.766-2.583 2.766-1.488 0-2.43-1.22-2.43-2.766 0-1.547 1.053-2.766 2.43-2.766zm1.096 4.793c1.237 0 2.247-1.053 2.247-2.348 0-1.296-1.01-2.348-2.247-2.348-1.236 0-2.246 1.052-2.246 2.348 0 1.295 1.01 2.348 2.246 2.348zm-1.096-3.84c.895 0 1.644.82 1.644 1.733 0 .913-.749 1.733-1.644 1.733-.896 0-1.645-.82-1.645-1.733 0-.913.749-1.733 1.645-1.733zm0 13.918c-.85 0-1.64-.176-2.404-.325-1.536-1.353-3.69-2.028-5.71-2.028-2.02 0-4.174.675-5.71 2.028-.764.149-1.554.325-2.404.325-.85 0-1.64-.176-2.404-.325-1.536-1.353-3.69-2.028-5.71-2.028-2.02 0-4.174.675-5.71 2.028-.764.149-1.554.325-2.404.325zM12 24c5.523 0 10-4.477 10-10S17.523 4 12 4 2 8.477 2 14s4.477 10 10 10zm0-18c3.314 0 6 2.686 6 6s-2.686 6-6 6-6-2.686-6-6 2.686-6 6-6zm0 10c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z" fill="#FFFFFF"></path></svg>
                        Sign in with Apple (Experimental)
                    </button>
                </div>
            </div>

            <!-- 1. Dashboard Tab -->
            <div id="dashboard" class="tab-content space-y-6 hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Reward Balance Card -->
                    <div class="md:col-span-2 bg-card p-6 rounded-xl shadow-xl border-t-4 border-primary">
                        <h2 class="text-xl font-bold text-gray-800 mb-2">Reward Balance</h2>
                        <p class="text-sm text-gray-500 mb-4">Screen time minutes earned for completed focus tasks.</p>
                        <div class="flex items-center space-x-4">
                            <span id="reward-balance-display" class="text-6xl font-extrabold text-primary">0</span>
                            <span class="text-2xl text-gray-600">minutes</span>
                        </div>
                    </div>
                    <!-- Screentime Mock Card -->
                    <div class="bg-card p-6 rounded-xl shadow-xl border-t-4 border-secondary">
                        <h2 class="text-xl font-bold text-gray-800 mb-2">Today's Usage</h2>
                        <p class="text-4xl font-extrabold text-secondary">4h 32m</p>
                        <p class="text-sm text-gray-500 mt-2">vs 3h 50m yesterday (Simulated)</p>
                        <!-- Simple bar chart mock -->
                        <div class="h-16 mt-4 flex items-end space-x-1">
                            <div class="w-1/6 bg-blue-200 h-2/3 rounded-sm"></div>
                            <div class="w-1/6 bg-blue-300 h-full rounded-sm"></div>
                            <div class="w-1/6 bg-blue-200 h-3/4 rounded-sm"></div>
                            <div class="w-1/6 bg-blue-100 h-1/2 rounded-sm"></div>
                            <div class="w-1/6 bg-blue-300 h-4/5 rounded-sm"></div>
                            <div class="w-1/6 bg-blue-400 h-1/4 rounded-sm"></div>
                        </div>
                    </div>
                </div>

                <!-- Usage Log Mock -->
                <div class="bg-card p-6 rounded-xl shadow-xl">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Recent Focus Rewards</h2>
                    <ul class="space-y-3 text-sm text-gray-700">
                        <li class="flex justify-between items-center border-b pb-2">
                            <span>Completed: Read 10 pages of book</span>
                            <span class="font-semibold text-primary">+3 min reward</span>
                        </li>
                        <li class="flex justify-between items-center border-b pb-2">
                            <span>Completed: Drafted project outline</span>
                            <span class="font-semibold text-primary">+5 min reward</span>
                        </li>
                        <li class="flex justify-between items-center pb-2">
                            <span>Completed: 30 minutes of exercise</span>
                            <span class="font-semibold text-primary">+7 min reward</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- 2. Focus & Reward Tab -->
            <div id="focus" class="tab-content hidden space-y-6">
                <div id="focus-setup-view" class="bg-card p-6 rounded-xl shadow-xl border-t-4 border-primary space-y-4">
                    <h2 class="text-2xl font-bold text-gray-800">Set Your Focus Task</h2>
                    <p class="text-gray-600">Trade productivity for screen time. You earn a specific reward for completing your task.</p>

                    <label for="task-description" class="block text-sm font-medium text-gray-700 pt-2">Task Description (e.g., Read 10 pages of "The Martian")</label>
                    <input type="text" id="task-description" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="What specific task will you complete?">

                    <label for="reward-minutes" class="block text-sm font-medium text-gray-700 pt-2">Screen Time Reward (in minutes)</label>
                    <div class="flex items-center">
                        <input type="number" id="reward-minutes" class="w-24 p-3 border border-gray-300 rounded-l-lg focus:ring-primary focus:border-primary text-center" value="3" min="1">
                        <span class="p-3 bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg text-gray-600">minutes</span>
                    </div>

                    <p class="text-sm text-red-500 hidden" id="focus-error"></p>

                    <button id="start-focus-btn" class="w-full py-3 bg-primary text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition-all mt-4">
                        Start Focus & Block Screen
                    </button>
                </div>

                <div id="focus-active-view" class="hidden bg-card p-6 rounded-xl shadow-xl border-t-4 border-secondary text-center space-y-6">
                    <h2 class="text-3xl font-extrabold text-secondary">FOCUS MODE ACTIVE</h2>
                    <p class="text-xl text-gray-700">You are currently focusing on:</p>
                    <p id="active-task-display" class="text-2xl font-semibold text-primary bg-green-50 p-3 rounded-lg"></p>
                    <p class="text-lg text-gray-600">The screen is now blocked. Stay focused!</p>

                    <div class="text-4xl font-bold text-gray-800">
                        <span id="focus-timer-display">00:00:00</span>
                    </div>

                    <button id="complete-task-btn" class="py-3 px-8 bg-primary text-white font-semibold rounded-full shadow-lg hover:bg-green-600 transition-all">
                        I've Completed the Task! Claim Reward
                    </button>
                    <button id="cancel-focus-btn" class="text-sm text-gray-500 hover:text-red-500 block w-full mt-4">
                        Cancel Focus (No reward earned)
                    </button>
                </div>

            </div>

            <!-- 3. WiseMind Chat Tab -->
            <div id="chat" class="tab-content hidden">
                <div class="bg-card rounded-xl shadow-xl flex flex-col h-[600px] border-t-4 border-secondary">
                    <!-- Chat Header -->
                    <div class="p-4 border-b border-gray-200 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-secondary mr-3">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.316-2.316L13.5 6l1.035-.259a3.375 3.375 0 0 0 2.316-2.316L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.316 2.316L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.316 2.316Z" />
                        </svg>
                        <span class="text-xl font-bold text-gray-800">WiseMind AI Assistant</span>
                    </div>

                    <!-- Chat Messages -->
                    <div id="chat-messages" class="chat-container flex-grow p-4 space-y-4 overflow-y-auto">
                        <!-- Initial Bot Message -->
                        <div class="flex justify-start">
                            <div class="bg-blue-100 text-gray-800 p-3 rounded-xl max-w-xs md:max-w-md shadow-md">
                                <span class="font-bold text-secondary">WiseMind:</span> Hello! I'm here to listen and offer supportive guidance. What's on your mind today?
                            </div>
                        </div>
                    </div>

                    <!-- Chat Input -->
                    <div class="p-4 border-t border-gray-200 flex items-center" id="chat-input-container">
                        <input type="text" id="chat-input" class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:ring-secondary focus:border-secondary" placeholder="Ask WiseMind anything...">
                        <button id="chat-send-btn" class="py-3 px-6 bg-secondary text-white font-semibold rounded-r-lg shadow-md hover:bg-blue-600 transition-all flex items-center justify-center">
                            <svg id="send-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.769 59.769 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" />
                            </svg>
                            <svg id="loading-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Generic Message Box for Alerts/Confirmations -->
            <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden">
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4 space-y-4">
                    <h3 id="message-title" class="text-xl font-bold text-gray-800">Alert</h3>
                    <p id="message-content" class="text-gray-600">This is a message.</p>
                    <div class="flex justify-end space-x-3">
                        <button id="msg-box-close" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all">Close</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const API_KEY = "AIzaSyBkhBGjSpPNUk_SnOzcH5pIsXBnyASC2aU"; // <<< CRITICAL: REPLACE WITH YOUR GEMINI API KEY >>>
        const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';

        // --- Firebase Configuration ---
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyDcZbVYbEJU76EcHAAUtLdN3l6bmsnFs_g",
            authDomain: "login-for-growise.firebaseapp.com",
            projectId: "login-for-growise",
            storageBucket: "login-for-growise.firebasestorage.app",
            messagingSenderId: "498109753227",
            appId: "1:498109753227:web:e87a2b8524a252b811b18e",
            measurementId: "G-X7FMF8F3Q3"
        };
        // --------------------------------

        // --- Firebase Setup ---
        let db, auth, userId, analytics;
        let rewardBalance = 0; // Local state for the reward balance

        // Globals provided by the environment (used for multi-user sandbox)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        document.addEventListener('DOMContentLoaded', initializeAppAndAuth);

        async function initializeAppAndAuth() {
            try {
                // We use the provided config for the app (USER_FIREBASE_CONFIG)
                const app = initializeApp(USER_FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);
                analytics = getAnalytics(app);
                
                // Hide the main content until authentication status is determined
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('login-prompt').classList.remove('hidden');

                // Wait for auth state to be set
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // User is signed in
                        userId = user.uid;
                        document.getElementById('user-id').textContent = user.email || user.uid;
                        document.getElementById('login-prompt').classList.add('hidden');
                        document.getElementById('dashboard').classList.remove('hidden');
                        
                        // Switch the tab bar back to the Dashboard state, enabling the main UI
                        showTab('dashboard'); 
                        
                        setupFirestoreListener();
                    } else {
                        // No user is signed in.
                        userId = null;
                        document.getElementById('user-id').textContent = 'Please Sign In';
                        // Show the login prompt and hide the main content
                        tabContents.forEach(content => content.classList.add('hidden'));
                        document.getElementById('login-prompt').classList.remove('hidden');
                    }
                });
                
                // If an initial sandbox token is provided, attempt to use it (for sandbox persistence)
                if (initialAuthToken && !auth.currentUser) {
                    await signInWithCustomToken(auth, initialAuthToken).catch(e => {
                         // If custom token fails, it might be expired, just proceed to normal sign-in flow
                         console.log("Custom token sign-in failed, proceeding to login prompt.");
                    });
                } else if (!auth.currentUser) {
                    // Fallback to anonymous sign-in only if no other mechanism exists, 
                    // but we rely on the login prompt for the main flow now.
                    // await signInAnonymously(auth); 
                }

            } catch (error) {
                console.error("Firebase initialization or authentication error:", error);
                document.getElementById('user-id').textContent = 'Auth Error';
                showMessage('Initialization Error', 'Could not initialize Firebase. Check console for details.');
            }
        }

        // --- Provider Sign-In Logic ---
        
        async function signInWithProvider(providerName) {
            let provider;
            
            if (providerName === 'google') {
                provider = new window.GoogleAuthProvider();
            } else if (providerName === 'github') {
                provider = new window.GithubAuthProvider();
            } else if (providerName === 'apple') {
                // Apple provider requires client configuration in a live environment
                provider = new window.OAuthProvider('apple.com');
            } else {
                console.error("Unknown provider:", providerName);
                return;
            }

            try {
                // Start sign-in with pop-up.
                await signInWithPopup(auth, provider);
                // The onAuthStateChanged listener handles the rest upon success.
                showMessage('Success!', `Signed in with ${providerName}. Welcome!`);
            } catch (error) {
                // Handle Errors here (e.g., pop-up closed, user cancelled)
                console.error("Sign-in error:", error);
                let errorMessage = error.message;
                if (error.code === 'auth/popup-closed-by-user') {
                     errorMessage = 'The sign-in window was closed.';
                } else if (error.code === 'auth/cancelled-popup-request') {
                     errorMessage = 'Sign-in cancelled.';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    errorMessage = 'This email is already registered with another provider.';
                }
                showMessage('Sign-in Failed', `Error: ${errorMessage}. Please try again.`);
            }
        }
        
        // --- Event Listeners for Login Buttons ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('google-login-btn').addEventListener('click', () => signInWithProvider('google'));
            document.getElementById('github-login-btn').addEventListener('click', () => signInWithProvider('github'));
            document.getElementById('apple-login-btn').addEventListener('click', () => signInWithProvider('apple'));
        });


        // --- Firestore Logic ---

        // Sets up real-time listener for reward balance
        function setupFirestoreListener() {
            const rewardDocRef = doc(db, `artifacts/${appId}/users/${userId}/rewards`, 'balance_doc');

            onSnapshot(rewardDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    // Update local state and UI
                    rewardBalance = docSnap.data().balance || 0;
                    updateRewardBalanceUI();
                } else {
                    // Initialize the balance if document doesn't exist
                    console.log("Reward balance doc does not exist, creating initial balance of 0.");
                    setDoc(rewardDocRef, { balance: 0 }).catch(e => console.error("Error setting initial balance:", e));
                    rewardBalance = 0;
                    updateRewardBalanceUI();
                }
            }, (error) => {
                console.error("Error listening to reward balance:", error);
            });
        }

        // Function to update the UI display
        function updateRewardBalanceUI() {
            document.getElementById('reward-balance-display').textContent = Math.round(rewardBalance);
        }

        // Function to add reward minutes
        async function addRewardMinutes(minutes) {
            if (!db || !userId) return showMessage('System Error', 'Authentication not ready. Cannot update reward.');

            try {
                const rewardDocRef = doc(db, `artifacts/${appId}/users/${userId}/rewards`, 'balance_doc');
                // Fetch the current state before setting
                const docSnap = await getDoc(rewardDocRef);
                const currentBalance = docSnap.exists() ? docSnap.data().balance : 0;
                const newBalance = currentBalance + minutes;

                await setDoc(rewardDocRef, { balance: newBalance });
                showMessage('Reward Earned!', `You earned ${minutes} minutes of screen time! New Balance: ${newBalance} minutes.`);
            } catch (error) {
                console.error("Error adding reward minutes:", error);
                showMessage('Error', 'Failed to update reward balance due to a database error.');
            }
        }

        // --- UI & Tab Management ---

        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        function showTab(tabId) {
            // Update buttons
            tabButtons.forEach(btn => {
                if (btn.dataset.tab === tabId) {
                    btn.classList.add('bg-primary', 'text-white');
                    btn.classList.remove('text-gray-500', 'hover:bg-gray-100');
                } else {
                    btn.classList.remove('bg-primary', 'text-white');
                    btn.classList.add('text-gray-500', 'hover:bg-gray-100');
                }
            });

            // Update content visibility
            tabContents.forEach(content => {
                if (content.id === tabId) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
            
            // Ensure login prompt is hidden if a functional tab is shown
            document.getElementById('login-prompt')?.classList.add('hidden');
        }

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Only allow switching tabs if a user is logged in
                if (userId) {
                    showTab(button.dataset.tab);
                } else {
                    showMessage('Sign In Required', 'Please sign in first to access the app features.');
                }
            });
        });


        // --- Message Box Implementation (Replaces alert/confirm) ---

        const msgBox = document.getElementById('message-box');
        const msgTitle = document.getElementById('message-title');
        const msgContent = document.getElementById('message-content');
        const msgCloseBtn = document.getElementById('msg-box-close');

        function showMessage(title, content) {
            msgTitle.textContent = title;
            msgContent.textContent = content;
            msgBox.classList.remove('hidden');
            msgBox.classList.add('flex');
        }

        msgCloseBtn.addEventListener('click', () => {
            msgBox.classList.add('hidden');
            msgBox.classList.remove('flex');
        });
        


        // --- Focus & Reward Logic ---
        const focusSetupView = document.getElementById('focus-setup-view');
        const focusActiveView = document.getElementById('focus-active-view');
        const startFocusBtn = document.getElementById('start-focus-btn');
        const completeTaskBtn = document.getElementById('complete-task-btn');
        const cancelFocusBtn = document.getElementById('cancel-focus-btn');
        const taskDescriptionInput = document.getElementById('task-description');
        const rewardMinutesInput = document.getElementById('reward-minutes');
        const activeTaskDisplay = document.getElementById('active-task-display');
        const focusError = document.getElementById('focus-error');
        const focusTimerDisplay = document.getElementById('focus-timer-display');

        let isFocusing = false;
        let earnedRewardMinutes = 0;
        let focusStartTime = null;
        let focusInterval = null;

        function updateTimerDisplay() {
            if (!focusStartTime) return;
            const elapsed = Date.now() - focusStartTime;
            const seconds = Math.floor(elapsed / 1000);
            const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
            const s = String(seconds % 60).padStart(2, '0');
            focusTimerDisplay.textContent = `${h}:${m}:${s}`;
        }

        startFocusBtn.addEventListener('click', () => {
            const task = taskDescriptionInput.value.trim();
            const reward = parseInt(rewardMinutesInput.value, 10);

            if (!task || task.length < 5) {
                focusError.textContent = 'Please provide a clear task description.';
                focusError.classList.remove('hidden');
                return;
            }
            if (isNaN(reward) || reward <= 0) {
                focusError.textContent = 'Reward must be a positive number of minutes.';
                focusError.classList.remove('hidden');
                return;
            }

            focusError.classList.add('hidden');
            isFocusing = true;
            earnedRewardMinutes = reward;

            // Update UI
            focusSetupView.classList.add('hidden');
            focusActiveView.classList.remove('hidden');
            activeTaskDisplay.textContent = task;

            // Start Timer (Simulated blocker)
            focusStartTime = Date.now();
            focusInterval = setInterval(updateTimerDisplay, 1000);

            showMessage('Focus Mode Started', `Screen time is now blocked! Focus on: "${task}" to earn ${reward} minutes.`);
        });

        completeTaskBtn.addEventListener('click', () => {
            if (!isFocusing) return;

            clearInterval(focusInterval);

            // Give reward
            addRewardMinutes(earnedRewardMinutes);

            // Reset state and UI
            isFocusing = false;
            earnedRewardMinutes = 0;
            focusStartTime = null;
            focusTimerDisplay.textContent = '00:00:00';
            focusSetupView.classList.remove('hidden');
            focusActiveView.classList.add('hidden');
        });

        cancelFocusBtn.addEventListener('click', () => {
            if (!isFocusing) return;
            clearInterval(focusInterval);
            isFocusing = false;
            earnedRewardMinutes = 0;
            focusStartTime = null;
            focusTimerDisplay.textContent = '00:00:00';
            focusSetupView.classList.remove('hidden');
            focusActiveView.classList.add('hidden');
            showMessage('Focus Cancelled', 'You cancelled the task. No screen time was awarded.');
        });


        // --- WiseMind Chatbot Logic ---

        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatMessages = document.getElementById('chat-messages');
        const sendIcon = document.getElementById('send-icon');
        const loadingSpinner = document.getElementById('loading-spinner');

        // Initial chat history structure for the API call
        let chatHistory = []; // Not used for this simulation, but structured for real API

        chatSendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        async function sendMessage() {
            const userText = chatInput.value.trim();
            if (!userText) return;
            if (!API_KEY) {
                showMessage('Chatbot Error', 'Gemini API Key is missing. Please insert your key into the script.');
                return;
            }

            // 1. Display User Message
            appendMessage(userText, 'user');
            chatInput.value = '';

            // 2. Show Loading
            chatSendBtn.disabled = true;
            sendIcon.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');

            // 3. Prepare and Call Gemini API (with Exponential Backoff)
            const systemPrompt = "You are WiseMind, an empathetic and non-judgemental AI assistant focused on mental wellness. Provide gentle, supportive, and action-oriented advice. Keep responses concise and focus on validation and practical steps. Never give medical advice or diagnose. Respond to the user's last message.";

            const userQuery = userText;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const maxRetries = 5;
            let responseText = "I'm having trouble connecting right now. Please ensure your API key is correct and check the browser console for CORS errors (which may require a backend proxy).";

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];
                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            responseText = candidate.content.parts[0].text;
                            break; // Success, exit loop
                        } else {
                            throw new Error("Invalid response structure from API.");
                        }
                    } else if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; // Retry
                    } else {
                        throw new Error(`API returned status ${response.status}`);
                    }
                } catch (error) {
                    console.error("API Call Error:", error);
                    if (i === maxRetries - 1) {
                         // Fall through to display the default error message
                    } else {
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }


            // 4. Display Bot Message
            appendMessage(responseText, 'bot');

            // 5. Hide Loading
            chatSendBtn.disabled = false;
            sendIcon.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');
        }

        function appendMessage(text, sender) {
            const messageEl = document.createElement('div');
            messageEl.className = 'flex ' + (sender === 'user' ? 'justify-end' : 'justify-start');

            const textEl = document.createElement('div');
            textEl.className = 'p-3 rounded-xl max-w-xs md:max-w-md shadow-md';
            textEl.innerHTML = sender === 'user' ? text : `<span class="font-bold text-secondary">WiseMind:</span> ${text}`;
            textEl.classList.add(sender === 'user' ? 'bg-primary text-white' : 'bg-blue-100 text-gray-800');

            messageEl.appendChild(textEl);
            chatMessages.appendChild(messageEl);

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

    </script>
</body>
</html>
